# Notion連携デバッグ結果レポート

## 問題の概要

アプリケーションで次のエラーが発生していました：
```
Could not find database with ID: 1c9a18c6-848c-80af-bbc3-edb875805be4. Make sure the relevant pages and databases are shared with your integration.
```

## 原因分析と対応

### 1. Notion IDの取り扱いの問題

**原因**: 
- Notionの親IDがデータベースIDとして設定されていましたが、以下の問題が発生していました。
  - IDのハイフンを除去する処理が入っていた（Notion APIが期待するフォーマットと異なる可能性）
  - IDがデータベースIDではなくページIDとして扱われるべきケースがあった可能性

**対応**:
- `notion_service.py`を修正しました：
  1. IDの種類を自動判別する処理を追加
     - まずデータベースIDとして検証
     - 失敗したらページIDとして検証
     - 両方失敗した場合はデフォルト動作（データベースIDとして扱う）
  2. 詳細なロギングを追加し、どのような処理が行われているか確認できるようにしました
  3. ハイフン付き/なしの両方のIDフォーマットを試す機能を追加しました

### 2. エラー発生箇所の特定

**原因**:
- エラーが`notion.pages.create`と`notion.blocks.children.append`のどちらで発生しているか特定できていませんでした。

**対応**:
- 各API呼び出しの前後に詳細なログを追加
- 例外処理の改善で、より明確なエラーメッセージを出力するようにしました

### 3. 検証ツールの作成

独立したNotionの検証スクリプト(`test_notion.py`)を作成し、以下の検証が可能になりました：
- APIキーの有効性の確認
- データベースIDの有効性の確認 
- IDがデータベースIDかページIDかの判別
- 実際のページ作成テスト

## 今後の確認事項

修正後も問題が解決しない場合は、以下を確認してください：

1. Notionインテグレーションの権限設定（Capabilities）
   - 「コンテンツの読み取り」「コンテンツの更新」権限が有効になっているか

2. インテグレーションとデータベースの共有設定
   - NotionデータベースとAPIインテグレーションが正しく共有されているか
   - 共有の手順：データベースのページ右上「・・・」→「接続を追加」→インテグレーション選択

3. データベース構造
   - タイトルプロパティが存在するか
   - データベースIDが正しいか（特に複数のデータベースがある場合）

## 最終確認

このアプリは以下の手順で議事録を作成しています：
1. NottaのWebhookデータを受信（ZapierからPOST）
2. AIで議事録を生成（Gemini/Claude/GPT）
3. Notionページを作成（初期メタデータブロック）
4. Notionページに議事録本文を追加（100ブロックずつ）

修正によって、これらの処理がすべて正常に機能することが期待されます。 